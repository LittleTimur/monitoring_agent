#!/bin/bash
# –°–∫—Ä–∏–ø—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
# –°–æ–∑–¥–∞–µ—Ç –±—ç–∫–∞–ø PostgreSQL –ë–î

set -e

echo "üíæ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö..."

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
DB_NAME="monitoring_agent"
DB_USER="agent_user"
BACKUP_DIR="backups"
TIMESTAMP=$(date +"%Y%m%d_%H%M%S")
BACKUP_FILE="${BACKUP_DIR}/monitoring_agent_${TIMESTAMP}.sql"

# –°–æ–∑–¥–∞–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–ª—è –±—ç–∫–∞–ø–æ–≤
mkdir -p $BACKUP_DIR

echo "üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö: $DB_NAME"
echo "üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: $DB_USER"
echo "üìÅ –§–∞–π–ª –±—ç–∫–∞–ø–∞: $BACKUP_FILE"

# –°–æ–∑–¥–∞–Ω–∏–µ –±—ç–∫–∞–ø–∞
pg_dump -U $DB_USER -d $DB_NAME -f $BACKUP_FILE

# –°–∂–∞—Ç–∏–µ –±—ç–∫–∞–ø–∞
gzip $BACKUP_FILE

echo "‚úÖ –†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: ${BACKUP_FILE}.gz"

# –£–¥–∞–ª–µ–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤ (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)
find $BACKUP_DIR -name "*.gz" -mtime +30 -delete

echo "üßπ –°—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã —É–¥–∞–ª–µ–Ω—ã (—Å—Ç–∞—Ä—à–µ 30 –¥–Ω–µ–π)"
echo "üìä –†–∞–∑–º–µ—Ä –±—ç–∫–∞–ø–∞: $(du -h ${BACKUP_FILE}.gz | cut -f1)"

